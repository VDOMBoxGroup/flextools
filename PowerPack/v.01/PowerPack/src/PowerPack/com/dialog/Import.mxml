<?xml version="1.0" encoding="utf-8"?>
<ModalDialog 
	xmlns="PowerPack.com.dialog.*" 
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:controls="ExtendedAPI.com.controls.*" 
	width="450" height="460"
	modal="false"
	title="{LanguageManager.sentences.lbl_import}" 
	xmlns:dialogClasses="PowerPack.com.dialog.dialogClasses.*">
	<mx:Script>
		<![CDATA[
			import generated.webservices.Export_applicationResultEvent;
			import vdom.connection.protect.MD5;
			import generated.webservices.List_applicationsResultEvent;
			import generated.webservices.Close_sessionResultEvent;
			import generated.webservices.Open_sessionResultEvent;
			import generated.webservices.Vdom;
			import vdom.connection.protect.Code;
			import mx.rpc.events.ResultEvent;
			import mx.controls.Alert;
			import mx.rpc.soap.WebService;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.soap.LoadEvent;
			import vdom.connection.soap.SoapEvent;
			import vdom.connection.soap.Soap;
			import mx.events.ItemClickEvent;
			import mx.utils.StringUtil;
			import PowerPack.com.managers.ContextManager;
			import PowerPack.com.managers.LanguageManager;
			
			private static var _dialog:Import;
			private var soap:Soap;
			
			static public function show(closeHandler:Function = null):Import
			{
				if(!_dialog || _dialog.closed) 
				{
					_dialog = new Import();	
					_dialog.open();
					_dialog.show(CANCEL, closeHandler, null, CANCEL);		
												
					var defaultCaptions:Object = {
						lbl_import: "Import",
						import_template: "Import template"
					};
					
					LanguageManager.setSentences(defaultCaptions);
				}				
				else 
				{
					_dialog.activate();
				}	
				
				return _dialog;
			}
			
			private function nextHandler(event:Event):void
			{
				switch(vsStep.selectedChild)
				{
					case step1:
						connect();		
						break;
				}
				
				if(vsStep.numChildren-1>vsStep.selectedIndex)
					vsStep.selectedIndex++;					
			}
			
			private function backHandler(event:Event):void
			{
				if(vsStep.selectedIndex>0)
					vsStep.selectedIndex--;
			}
			
			private function connect():void
			{
             	/*
             	var ws:WebService = ContextManager.instance.ws;	
             	ws.wsdl = ContextManager.instance.host+":"+
             		(ContextManager.instance.use_def_port?ContextManager.instance.default_port:ContextManager.instance.port)+
             		"/vdom.wsdl";
             	ws.wsdl = "http://192.168.0.24:80/vdom.wsdl"
				ws.useProxy = false;
				ws.addEventListener(LoadEvent.LOAD, loadCompleteHandler);
				ws.addEventListener(FaultEvent.FAULT, faultHandler);
				ws.loadWSDL();
				*/
				
				ContextManager.instance.vdom = new Vdom(null, 
					ContextManager.instance.host+":"+
             		(ContextManager.instance.use_def_port?ContextManager.instance.default_port:ContextManager.instance.port)+
             		"/SOAP");
             		
				var ws:Vdom = ContextManager.instance.vdom;             	
             	ws.addVdomFaultEventListener(faultHandler);
             	
             	login();
			}
			
			private  function faultHandler(event:FaultEvent):void 
			{
				Alert.show("A fault occured contacting the server. Fault message is: " + event.fault.faultString+
				"\n"+event.fault.faultDetail+
				"\n"+event.fault.rootCause+'\n'+event.headers);
			}			
			
			/*
			private function loadCompleteHandler(event:Event):void 
			{
				var ws:WebService = ContextManager.instance.ws;	
				ws.removeEventListener(LoadEvent.LOAD, loadCompleteHandler);
				login();
			}
			*/
			
			private function login():void
			{	
             	//var ws:WebService = ContextManager.instance.ws;
				var ws:Vdom = ContextManager.instance.vdom;
             	var login:String = ContextManager.instance.login;
				var pwd_md5:String = MD5.encrypt(ContextManager.instance.pass);   
				
				ws.addopen_sessionEventListener(loginHandler);
				ws.open_session(login, pwd_md5);
				
             	//ws.open_session.addEventListener(ResultEvent.RESULT, loginHandler);			
				//ws.open_session(login, pwd_md5);
			}	
			
			private  function loginHandler(event:Open_sessionResultEvent):void
			{
				var resultXML:XML = new XML(<Result />);
				resultXML.appendChild(XMLList(event.result));				
				
				if(resultXML.Error.toString()) {
					Alert.show(resultXML.Error)
				} 
				else {					
					// run session protector
					var code:Code = Code.getInstance();
					code.init(resultXML.Session.HashString);
					code.inputSKey(resultXML.Session.SessionKey);
					code.sessionId = resultXML.Session.SessionId;
					
					getAppList();
				}
			}
	
			private function logout():void
			{	
             	//var ws:WebService = ContextManager.instance.ws;
             	var ws:Vdom = ContextManager.instance.vdom;
				var code:Code = Code.getInstance();
				var sid:String = code.sessionId; 
				
				//ws.addclose_sessionEventListener(logoutHandler);
				ws.close_session(sid);
				
				//ws.close_session.addEventListener(ResultEvent.RESULT, onLogout);
				//ws.close_session(sid);
			}
			
			private function getAppList():void
			{
				//var ws:WebService = ContextManager.instance.ws;
				var ws:Vdom = ContextManager.instance.vdom;
				var code:Code = Code.getInstance();
				var sid:String			= code.sessionId; 
				var skey:String  		= code.skey(); 
				
				ws.addlist_applicationsEventListener(getAppListHandler);
				ws.list_applications(sid, skey);
				//ws.list_applications.addEventListener(ResultEvent.RESULT, onGetAppList);
				//ws.list_applications(sid, skey);
			}

			private  function getAppListHandler(event:List_applicationsResultEvent):void
			{
				var resultXML:XML = new XML(<Result />);
				resultXML.appendChild(XMLList(event.result));	
				
				if(resultXML.Error.toString() == 'Error') {
					Alert.show(resultXML.Error);
				} 
				else {	
					trace(resultXML)
					importApp();
				}
			}
			
			private function importApp():void
			{
				//var ws:WebService = ContextManager.instance.ws;
				var ws:Vdom = ContextManager.instance.vdom;
				var code:Code = Code.getInstance();
				var sid:String = code.sessionId; 
				var skey:String	= code.skey();
				var appid:String;
				
				var resultXML:XML = new XML(<Result />);				
				resultXML.appendChild(XMLList(ws.list_applications_lastResult));
				
				appid = resultXML..Application[0].@ID;
				appid = '58a4358d-2dce-4bd3-ace9-62a72316d84d';
				
				ws.addexport_applicationEventListener(importAppHandler);
				ws.export_application(sid, skey, appid);
			}						

			private  function importAppHandler(event:Export_applicationResultEvent):void
			{
				var resultXML:XML = new XML(<Result />);
				resultXML.appendChild(XMLList(event.result));	
				
				if(resultXML.Error.toString() == 'Error') {
					Alert.show(resultXML.Error);
				} 
				else {
            			var file:File = new File('c:/output/app.xml');
           				var fileStream:FileStream = new FileStream();					
      					
      					fileStream.open(file, FileMode.WRITE);
						fileStream.writeUTFBytes(resultXML.toXMLString());
						fileStream.close();	
					
					//trace(resultXML);
					logout();
				}
			}
					
		]]>
	</mx:Script>
	
	<mx:VBox styleName="dlgHeader" width="100%">
		<mx:Label text="{LanguageManager.sentences.import_template}" styleName="headerLabel"/>
	</mx:VBox>
	
	<mx:HRule width="100%"/>
	
	<mx:ViewStack width="100%" height="100%" selectedIndex="0" id="vsStep">

		<dialogClasses:ImportStep1 styleName="dlgContent" width="100%" height="100%" id="step1"/>
		
	</mx:ViewStack>

	<mx:HRule width="100%"/>
	
	<mx:ControlBar width="100%" styleName="dlgFooter">
		<mx:Button label="&lt; {LanguageManager.sentences.back}" click="backHandler(event)"/>
		<mx:Button label="{LanguageManager.sentences.next} &gt;" click="nextHandler(event)"/>
	</mx:ControlBar>
	
</ModalDialog>
