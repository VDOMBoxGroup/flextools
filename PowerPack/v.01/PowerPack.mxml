<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" xmlns:ns1="http://www.adobe.com/2006/fc"   
	initialize="init()" creationComplete="show()" xmlns:ns3="PowerPack.com.*" xmlns:ns4="PowerPack.com.graph.*" xmlns:ns5="*">
	<mx:Script>
		<![CDATA[
			import PowerPack.com.graph.GraphAccordionChild;
			import mx.events.ListEvent;
			import mx.events.CloseEvent;
			import PowerPack.com.graph.GraphEditTab;
			import PowerPack.com.mdm.filesystem.FileBrowser;
			import PowerPack.com.mdm.filesystem.FileUtils;
			import PowerPack.Log;
			import mdm.*;
			import PowerPack.com.mdm.*;

			import PowerPack.com.*;
			import PowerPack.com.graph.GraphCanvas;
			import PowerPack.com.graph.GraphNode;
			import PowerPack.com.graph.GraphArrow;
			import PowerPack.com.gen.*;
			import PowerPack.com.mdm.filesystem.*;

			import mx.events.MenuEvent;
			import mx.controls.Alert;
			import mx.managers.PopUpManager;
			
 		    import flash.errors.*;
		    import flash.events.*;
		    import flash.net.URLLoader;
		    import flash.net.URLRequest;
			import PowerPack.com.mdm.*;
		
		    //--------------------------------------------------------------------------
		    //
		    //  Variables and properties
		    //
		    //--------------------------------------------------------------------------
	          		
           	private var settingsRequest:URLRequest;
            private var settingsLoader:URLLoader;

            private var langRequest:URLRequest;
            private var langLoader:URLLoader;
            
            private var tmplRequest:URLRequest;
            private var tmplLoader:URLLoader;
            
            private var tmplStruct:TemplateStruct;

            [Bindable]
            public var settingsXML:XML = new XML(<settings></settings>);
            
            [Bindable]
            public var langXML:XML;
            
            [Bindable]
            public var templateXML:XML;
            
            public var curOpenFile:String;            
 		
			//--------------------------------------------------------------------------
			//
			//  Class methods
			//
			//--------------------------------------------------------------------------  	
						
			private function init():void 
			{	    	 
				Init.initialised;				
				
				application.addEventListener("applicationExiting", exitApplicationHandler);
				application.addEventListener(ErrorEvent.ERROR, errorHandler);
				
				appCtrlBar.height = 0;
				appCtrlBar.visible = false;			
				
				// Load application settings
	            settingsRequest = new URLRequest("settings.xml");
	            settingsRequest.method = URLRequestMethod.POST;
    	        settingsLoader = new URLLoader();
        	    settingsLoader.addEventListener(Event.COMPLETE, completeSettingsHandler);
				
				// Load language file
	            langRequest = new URLRequest("lang/english.xml");
	            langRequest.method = URLRequestMethod.POST;
    	        langLoader = new URLLoader();
        	    langLoader.addEventListener(Event.COMPLETE, completeLangHandler);
	                    	  
	            // Create loader for template  
	            tmplRequest = new URLRequest();
	            tmplRequest.method = URLRequestMethod.POST;
    	        tmplLoader = new URLLoader();
        	    tmplLoader.addEventListener(Event.COMPLETE, completeTemplateHandler);
		    }
		    
		    private function show():void
		    {
				var bExists:Boolean = true;
						    	
				// for MDM Zinc context menu				
				addEventListener(MouseEvent.MOUSE_OVER, mouseOverHandler);

        	    bExists = FileUtils.isFileExists(settingsRequest.url);        	    
        	    if(bExists)
	               	settingsLoader.load(settingsRequest);

        	    bExists = FileUtils.isFileExists(langRequest.url);
          	    if(bExists)
       	   			langLoader.load(langRequest); 
    	   		      		
		    }
	       	
	       	public function saveSettings():void
	       	{
	       		if(settingsXML.name() != "settings");
		       		settingsXML = new XML(<settings></settings>);
	       		
	       		settingsXML.lastopenfile = curOpenFile?curOpenFile:"";
	       		
   	        	var fileData:String = settingsXML.toXMLString();
            	mdm.FileSystem.saveFile(settingsRequest.url, fileData);					
	       	}
	       	
	       	private function errorHandler(event:ErrorEvent):void
	       	{
	       		Alert.show("Application Error!!!");
	       	}
	       	private function exitApplicationHandler(event:Event):void
	       	{
	       		exitApplication();
	       	}
	       	
	       	public function exitApplication():void
	       	{
				// Save settings
				saveSettings();

            	mdm.Application.exit("ask","Are you sure you want to exit?");	       		
	       	}
	    	    
			//--------------------------------------------------------------------------
		    //
		    //  Event handlers
		    //
		    //--------------------------------------------------------------------------
		    
	        private function completeSettingsHandler(event:Event):void
	        {
	            settingsXML = XML(event.target.data);
				
				// Open last opened file	            
	            curOpenFile = settingsXML.lastopenfile.toString().length>0 ? settingsXML.lastopenfile : null;

            	var exists:Boolean = true;
            	exists = FileUtils.isFileExists(curOpenFile);
            	if(curOpenFile && exists)
            	{
	            	tmplRequest.url = curOpenFile;
    	    	    tmplLoader.load(tmplRequest); 	            
            	}
	        }		    
	        private function completeLangHandler(event:Event):void
	        {
	            langXML = XML(event.target.data);
	            
	            GraphArrow.langXML = langXML;
	            GraphNode.langXML = langXML;
	            GraphCanvas.langXML = langXML;
	            
        	    Alert.yesLabel = langXML.yes;
                Alert.noLabel = langXML.no;	 
                Alert.cancelLabel = langXML.cancel;         
	        }
	        private function completeTemplateHandler(event:Event):void
	        {
	            templateXML = XML(event.target.data);         
	        }	        
	    	    	
	    	private function mouseOverHandler(event:MouseEvent):void
	   		{	    	
	    		MDMContextMenu.refreshMenu(this);
	    		event.stopPropagation();
	    	}

            // Event handler for the MenuBar control's itemClick event.
            private function menuHandler(event:MenuEvent):void  
            {
                var fileBrowser:FileBrowser;
                var fileData:String;
                
                if(event.item.@id == "new")
                {
                	curOpenFile = null;
	                graphsPanel.clear();
                }
                if(event.item.@id == "new_tab")
                {
                	var newTabDialog:GraphEditTab = GraphEditTab.show();
                	newTabDialog.addEventListener(CloseEvent.CLOSE, newTabDialogCloseHandler);
                }
                else if(event.item.@id == "open_file")
                {		
                	fileBrowser = new FileBrowser();
	            	fileBrowser.langXML = langXML;
                	
                	PopUpManager.addPopUp(fileBrowser, this, true);
                	PopUpManager.centerPopUp(fileBrowser);               	
                	fileBrowser.addEventListener("closeBrowse", openBrowseHandler);
                }
                else if(event.item.@id == "close")
                {		
              		curOpenFile = null;
	                graphsPanel.clear();
                }                
    	        else if(event.item.@id == "save")
    	        {
    	        	if(!curOpenFile)
    	        	{
                		fileBrowser = new FileBrowser();
	            		fileBrowser.langXML = langXML;
                	
                		PopUpManager.addPopUp(fileBrowser, this, true);
                		PopUpManager.centerPopUp(fileBrowser);
                		fileBrowser.addEventListener("closeBrowse", saveBrowseHandler); 
              		} 
              		else
              		{		            		
		            	fileData = graphsPanel.toXML().toXMLString();
		            	mdm.FileSystem.saveFile(curOpenFile, fileData);             		
              		}	        
    	        }
				else if(event.item.@id == "save_as")
				{
            		fileBrowser = new FileBrowser();
	            	fileBrowser.langXML = langXML;
            	
            		PopUpManager.addPopUp(fileBrowser, this, true);
            		PopUpManager.centerPopUp(fileBrowser); 
            		fileBrowser.addEventListener("closeBrowse", saveBrowseHandler); 				
				}
				else if(event.item.@id == "language")
				{
	            	langRequest.url = "lang/"+event.item.@data;
        	    	langLoader.load(langRequest);					
				}
				else if(event.item.@id == "exit")
				{
					exitApplication();
				}     
				else if(event.item.@id == "generate")
				{
					//try
					{
						tmplStruct = new TemplateStruct(graphsPanel.toXML());
						tmplStruct.addEventListener("generationComplete", generationComplete);					
						tmplStruct.Generate();
					}
					//catch(e:Error) 
					//{
						//Alert.show(e.message, "Warning!");
					//}
				}     
            }
            
            private function newTabDialogCloseHandler(event:CloseEvent):void
            {            	
            	if(event.target.caption)
            	{
					var graphAccordionChild:GraphAccordionChild = new GraphAccordionChild();
					graphAccordionChild.label = event.target.caption;
					graphsPanel.graphsAccordion.addChild(graphAccordionChild);
		
					graphAccordionChild.lstGraphs.addEventListener(ListEvent.CHANGE, graphsPanel.changeLstGraphsHandler);
					graphAccordionChild.lstGraphs.addEventListener("doubleClick", graphsPanel.btnRenameClickHandler);
					graphAccordionChild.lstGraphs.addEventListener("completeEdit", graphsPanel.completeEditLstGraphsHandler);            	
            	}
            }
           	private function generationComplete(event:Event):void
           	{
           		Log.show("Data saved to app.xml.\n" + tmplStruct.buffer);
           		
				if(tmplStruct.buffer)
					mdm.FileSystem.saveFile("app.xml", tmplStruct.buffer);            		
           	}
           	
            private function openBrowseHandler(event:Event):void
            {
            	if(event.target.selectedItem.type != "file")
            		return;
            		
            	var exists:Boolean = FileUtils.isFileExists(event.target.selectedItem.path);

            	if(!exists)
            		return;
            		
            	tmplRequest.url = event.target.selectedItem.path;
        	    tmplLoader.load(tmplRequest);  
            	
            	//var fileData:String = mdm.FileSystem.loadFile(event.target.selectedItem.path);
            	//templateXML = new XML(fileData);

            	curOpenFile = event.target.selectedItem.path;
            }
            
            private function saveBrowseHandler(event:Event):void
            {
            	if(event.target.selectedItem.type != "file")
            		return;
            		            	
            	var fileData:String = graphsPanel.toXML().toXMLString();
            	mdm.FileSystem.saveFile(event.target.selectedItem.path, fileData);
            	
            	curOpenFile = event.target.selectedItem.path;
            }

		]]>
	</mx:Script>
        
	<mx:VBox top="10" left="10" bottom="10" right="10">
		
		<mx:MenuBar labelField="@label" itemClick="menuHandler(event);" 
		        dataProvider="{langXML.mainmenu.menuitem}" width="100%"></mx:MenuBar>
		
		<mx:ApplicationControlBar width="100%" height="69" id="appCtrlBar">
			<mx:TabNavigator height="100%" width="100%">
				
				<mx:Canvas label="File" width="100%" height="100%">
				</mx:Canvas>
				
				<mx:Canvas label="Import" width="100%" height="92">
				</mx:Canvas>
				
				<mx:Canvas label="VDOM Box" width="100%" height="100%">
				</mx:Canvas>
				
			</mx:TabNavigator>
		</mx:ApplicationControlBar>
		
		<mx:Spacer width="100%"/>
		
		<mx:HDividedBox height="100%" width="100%">
				
			<ns4:GraphPanel
				id="graphsPanel"
				langXML="{langXML}" 
				templateXML="{templateXML}"
				vsViewStack="{viewstack}">
			</ns4:GraphPanel>
			
			<mx:Panel width="100%" height="100%" layout="absolute" title="{langXML.designpanel.title}">
				<mx:ViewStack id="viewstack" width="100%" height="100%">
				</mx:ViewStack>
			</mx:Panel>
			
		</mx:HDividedBox>
	</mx:VBox>
</mx:Application>
