<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 implements="net.vdombox.ide.modules.dataBase.interfaces.IEditor" 
		 width="400" height="300">
	
	<fx:Script>
		<![CDATA[
			import mx.collections.ArrayCollection;
			import mx.controls.dataGridClasses.DataGridColumn;
			import mx.utils.UIDUtil;
			
			import net.vdombox.ide.common.vo.PageVO;
			import net.vdombox.ide.modules.dataBase.events.QueueEvent;
			import net.vdombox.ide.modules.dataBase.model.vo.StructureVO;
			import net.vdombox.ide.modules.dataBase.view.components.ItemRenderers.TextInputItemRenderers;
			import net.vdombox.ide.modules.dataBase.view.components.Queue.QueueManager;
			
			private var _objectVO : PageVO;
			
			private var manager : *;
			private var queue : QueueManager;
			private var queryResult:XML;
			private var tableStructureXML:XML;
			private var page:XML; /* of XML */
			private var dataGridColumns:Array = [];
			private var dataGridColumnsProps:Array = [];
			
			[Bindable]
			private var dataGridProvider:ArrayCollection = new ArrayCollection();
			
			public function get editorID() : String
			{
				return _objectVO ? _objectVO.id : "";
			}
			
			public function get editorName() : String
			{
				return _objectVO ? _objectVO.name : "";
			}
			
			public function get objectVO() : Object
			{
				return _objectVO ? _objectVO : null;
			}
			
			public function set objectVO( value : Object ) : void
			{
				_objectVO = value as PageVO;
			}
			
			public function set externalManager( ref: * ) : void 
			{
				manager = ref;
				queue = new QueueManager( manager );
				
				/* Permanent event listener */
				queue.addEventListener( QueueEvent.QUEUE_INTERRUPT, errorHandler );	
				
				queue.reset();
			}
			
			private function errorHandler( event : QueueEvent ) : void 
			{
				//showMessage( event.message );
			}
			
			protected function sendQuery_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				var textQuery : String = query.text;
				queue.addRequest( UIDUtil.createUID(), "execute_query_xml",
					'<query_sql>' + textQuery + '</query_sql>', writeQueryResultOnDataGrid, queueERRORHandler );
				queue.addEventListener( QueueEvent.QUEUE_COMPLETE, queueOnLoadCompleteHandler );
				queue.addEventListener( QueueEvent.UNKNOWN_ERROR, queueERRORHandler );
				queue.execute();
			}
			
			private function writeQueryResultOnDataGrid( message : String ) : void 
			{
				try 
				{
					queryResult = new XML( message );	
					tableStructureXML = new XML( queryResult.queryresult.table.header );
					
					setTableHeaders();
					page = new XML(queryResult.queryresult.table.data );
					
					showPageData();
				}
				catch ( err : Error ) 
				{ 
					return;	
				}
			}
			
			private function setTableHeaders():void 
			{
				
				dataGridColumns = [];
				for each (var xmlHeader:XML in tableStructureXML.column) 
				{
					var _header:DataGridColumn = new DataGridColumn();
					var columnProps : StructureVO = new StructureVO( xmlHeader );
					
					dataGridColumnsProps.push( columnProps );
					_header.dataField = xmlHeader.@name;
					_header.sortable = true;
					_header.itemRenderer = new ClassFactory( TextInputItemRenderers );
					
					dataGridColumns.push( _header );
					
				}
				dataTable.columns = dataGridColumns;
				
			}
			
			private function showPageData() : void 
			{
				
				/* Show current page */
				dataGridProvider = new ArrayCollection();
				for each ( var xmlRow:XML in page.row ) 
				{
					/* Create tableRow object */
					var tableRow:Object = new Object();
					var cellIndex:int = 0;
					for each ( var xmlCell:XML in xmlRow.cell ) 
					{
						tableRow[ dataGridColumns[ cellIndex ].dataField ] = xmlCell.toString();
						cellIndex++;
					}
					
					tableRow["fnew"] = false;
					tableRow["changed"] = false;
					tableRow["GUID"] = UIDUtil.createUID(); 
					dataGridProvider.addItem( tableRow );
				}
				
			}
			
			private function queueOnLoadCompleteHandler( message : String ) : void 
			{
				queue.removeEventListener( QueueEvent.QUEUE_COMPLETE, queueOnLoadCompleteHandler );
				queue.removeEventListener( QueueEvent.UNKNOWN_ERROR, queueERRORHandler );
				errorWriter.text = "Success";
			}
			
			private function queueERRORHandler( event : QueueEvent ) : void 
			{
				queue.removeEventListener( QueueEvent.QUEUE_COMPLETE, queueOnLoadCompleteHandler );
				queue.removeEventListener( QueueEvent.UNKNOWN_ERROR, queueERRORHandler );
				errorWriter.text = event.message;	
				queue.reset();
				dataGridProvider = null;
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:VGroup width="100%" height="100%">
		
		<s:Group width="100%" height="100">
			
			<s:VGroup width="100%" height="100%" gap="3" paddingBottom="4" horizontalAlign="right">
				
				<s:TextArea id="query" width="100%" height="100%" />
				
				<s:HGroup width="100%" height="20" horizontalAlign="right" verticalAlign="middle" paddingRight="10">
					
					<s:Button id="sendQuery" label="send query" click="sendQuery_clickHandler(event)"/>
					
				</s:HGroup>
				
				
				<s:TextInput id="errorWriter" width="100%" editable="false" />
				
			</s:VGroup>
			
		</s:Group>
		
		<mx:DataGrid id="dataTable" dataProvider="{dataGridProvider}"
					 width="100%" height="100%" horizontalScrollPolicy="auto" verticalScrollPolicy="auto"
					 editable="false" sortableColumns="false" />
		
		
		
	</s:VGroup>
	
</s:Group>
