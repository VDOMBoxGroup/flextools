<?xml version="1.0" encoding="utf-8"?>
<ClosablePanel
	
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns="vdom.components.edit.containers.*"
	
	creationComplete="creationCompleteHendler()"
	width="100%">

<mx:Metadata>
		[Event(name="change", type="mx.events.ListEvent")]
</mx:Metadata>

<mx:Script>
	<![CDATA[
		import mx.events.ListEvent;
	//implements Event;
		import mx.controls.listClasses.ListBase;
		import vdom.managers.FileManager;
		import mx.controls.Image;
	//	import vdom.managers.ResourceManager;
		import mx.messaging.management.Attribute;
		import mx.collections.XMLListCollection;
		import mx.events.FlexEvent;
		import mx.controls.Tree;
			
			
		//	[Embed(source="/icons/ScrollableMenu.png"  )] 
         //   public var menu_icon:Image; 
         
         // public static const CHANGE:String = "change";
          
	
	
            [Embed(source="/icons/HSlider.png")]
            public var slider_icon:Class; 
            [Embed(source="/icons/SuperTabNavigator.png")]
            public var tab_icon:Class; 
			[Embed(source="/icons/HAccordion.png")]
            public var accordion_icon:Class; 
            [Embed(source="/icons/DragScrollingCanvas.png")]
            public var drag_icon:Class;
            [Embed(source="/icons/VerticalMenuBar.png")]
            public var vmenu_icon:Class;
            [Embed(source="/icons/UtilIcon.png")]
            public var util_icon:Class;
            
            [Embed(source="/icons/ConvertibleTreeList.png")]
            public var ctree_icon:Class;
            
           
            
		import vdom.managers.DataManager;
		import mx.core.Application;
		
		[Bindable]
		private var publicData:Object;
		private var dataManager:DataManager;
		private var tree:Tree = new Tree();
		private var xmlTreeData:XML;
		[Bindable]
		private var topLevelObjectId:Object;
		private var arrPicture:Array = new Array();
		
		public var selectedItem:XMLList;
		
		private function creationCompleteHendler():void
		{
			 
			dataManager = DataManager.getInstance();
		//trace('ObjPanel: '+dataManager.listPages);
			    tree.percentHeight = 100;//width = 200;
			    tree.percentWidth = 100;
				tree.showRoot = false; 
				tree.iconField = "@icon"; 
				tree.labelField = "@label";
				
			
				tree.addEventListener(FlexEvent.UPDATE_COMPLETE, treeUpdateComletLister);
				tree.addEventListener(Event.CHANGE, treeChangeLister);
			    
			    addChild(tree);
		}
		
		public function set dataProvider(xmlData:XMLList):void {
			
			if(xmlData) 
			{
				// создаем обьекты верхнего уровня
				 xmlTreeData = <root/>;
				for each(var xmlLabel:XML in xmlData)
				{
					if (xmlLabel.name() == 'Parent') continue;
					
					var xmlList:XMLList = new XMLList('<Object/>');
					xmlList.@label = xmlLabel.@Name;
					xmlList.@showInList = 'true';
					xmlList.@ID = xmlLabel.@ID;
					
					xmlList.appendChild(findOjects(xmlLabel.Objects));
				//	trace(xmlLabel.Objects)
					
					xmlTreeData.appendChild(xmlList);
			} 
		//	trace('++++++++++++++\n '+xmlObjects.Object.Objects);
			// для текущего обьекта верхнего уровня подгружаем его элементы
		/*	var xmlObjects:XMLList = dataManager.currentObject;
			var strCurObjID:String = xmlObjects.Object.@ID;
			// findOjects(XML) функция которая рекурсивно ищет обьекты...
 			xmlTreeData.Object.(@ID == strCurObjID).appendChild(findOjects(xmlObjects.Object.Objects));
		//	trace('**** xmlTreeData: \n'+xmlTreeData);
			*/
			tree.dataProvider = xmlTreeData;
			getIcons();
			}
		}
		
	
	
		private function treeUpdateComletLister(evt:Event):void
		{	
				topLevelObjectId = dataManager.currentPageId //publicData.topLevelObjectId;
				if(topLevelObjectId && xmlTreeData) 
					tree.selectedItem = xmlTreeData.Object.(@ID == topLevelObjectId)[0];
		}
		
		private function treeChangeLister(evt:Event):void
		{
			  var selectedNode:XML = Tree(evt.target).selectedItem as XML;
              var ID:String = selectedNode.@ID;
            //  trace('selected: ' + ID);
              if(xmlTreeData.Object.(@ID == ID).toXMLString() != "" )
              {
          		   	dataManager.changeCurrentPage(selectedNode.@ID);
              } else
              {
              		dataManager.changeCurrentObject(ID);
              }
              
		}

	//	public var  change:String = Event.CHANGE; 
	
		private function findOjects(xmlIn:XMLList):XMLList
		{
			var xmllReturn:XMLList  = new XMLList();
			for each(var xmlLabel:XML in xmlIn.children())
			{
				var xmlTemp:XML = new XML('<Object/>');
					xmlTemp.@label 	= xmlLabel.@Name;
					xmlTemp.@ID 	= xmlLabel.@ID;
					xmlTemp.@Type 	= xmlLabel.@Type;
//					arrPicture['8bb9ff5c-71e3-4278-bb8d-d668eAdelfos'] = new Image();
					
					//xmlTemp.@icon	=  IconUtility.getClass(tree,'http://onair.adobe.com/images/mesh.jpg', 32, 32);
					xmlTemp.@icon	= 'drag_icon';
					// var str:String = tree.itemToDataTip(imageName);
		//			var objTemp:Object = tree.iconFunction(imageName);
		//	trace('++++str:+++ '+ str);
				// проверяем есть ли еще обьекты в нутри
				var numObjects:int = xmlLabel.Objects.*.length(); 
				if(numObjects > 0)	xmlTemp.appendChild(findOjects(xmlLabel.Objects));
				
				xmllReturn += xmlTemp;
			}
			return xmllReturn;
		}
		
		private function getIcons ():void
		{
			trace('run function getIcon');	
		//	var resMan:FileManager = FileManager.getInstance();
		//		resMan.loadResource(publicData.applicationId, 'abb9ff5c-71e3-4278-bb8d-d668eAdelfos', this);
		}
		
		public function set resource (object:Object):void
		{
			trace('run function set Resource: ' + object.resourceID);	
	//		this[object.resourceID] = Class;
			arrPicture[object.resourceID] = object.data;
		//	trace('source: '+object.data.source);
		//	trace('1object.guid' + object.resourceID);
		
	
		}
		
	]]>
</mx:Script>
	
</ClosablePanel>
