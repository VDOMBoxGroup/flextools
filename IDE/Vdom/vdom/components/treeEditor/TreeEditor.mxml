<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas
 xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" creationComplete="creationCompleteHandler()" hide="hideHendler()" 
			show="showHnadler()" label="add Element" xmlns:ns1="vdom.components.treeEditor.colormenu.*" xmlns:colorMenu02="vdom.components.treeEditor.colorMenu02.*" xmlns:treeEditor="vdom.components.treeEditor.*">
	
<mx:Metadata>
		[ResourceBundle("Tree")]
</mx:Metadata>	
<mx:HBox width="100%" height="100%">
<mx:VBox width="100%" height="100%">
	

<mx:Canvas id="main"   width="100%" height="100%" backgroundColor="#ffffff" moveEffect="itemsChangeEffect1">

<mx:Script>
	<![CDATA[
		import mx.effects.easing.Elastic;
		import vdom.containers.ApplicationPanel;
		import mx.core.Application;
		import vdom.events.TreeEditorEvent;
		import vdom.events.DataManagerEvent;
		import vdom.events.AddTreeElementEvent;
		import mx.managers.PopUpManager;
		import mx.controls.Alert;
		import vdom.managers.FileManager;
		import vdom.managers.DataManager;
		import mx.events.CloseEvent;
		
		include "TreeEditorScript.as";
		
		
 	private var massTreeElements:Array = new Array();
	private var massLines:Array = new Array();
	private var masIndex:Array = new Array();
	private var masMaxOfIndex:Array = new Array();
	private var curTree:Object = new Object();
	private var canLine:Canvas = new Canvas();
	private var pnFrom:Point = new Point();
	private var blDrawLine:Boolean = false;
	private var vctTest:Vector2 = new Vector2();
	private var curLine:Object = new Object();
	private var dataManager:DataManager  = DataManager.getInstance();
	private var xmlApplicationStructure:XML;
	private var btLine:DeleteLineButton = new DeleteLineButton();

/******* 
 * 			to Do
 * 	
 * 		* добавлять новый елемент в самый низ 
 * 		* у трее елемента сменить по умолчанию картинку
 * 		* у трии елемента картинка в соответстви с его типом.
 * 		??? массив элементов строить из другого места(массив "сортируемегого дерева" строить так же)
 * 		* делетеБТ должен исчезать когда нажимается другой елемент
 * 		* при создании нового елемента блокировать кнопку "ок"
 * 		* выделить новосозданный елемент
 * 		
 * */
	
	private var fileManager:FileManager = FileManager.getInstance();
	
	private function creationCompleteHandler():void
	{
		 fileManager = FileManager.getInstance();
	}
	
	private function showHnadler():void
	{
		
		if(!main) 
			main = new Canvas();
	/*
		if(!btLine)
			btLine = new DeleteLineButton();
		*/
		addTreeEditorListeners();
			
		dataManager.getApplicationStructure();
	}
	
	private function hideHendler():void
	{
		removeAllLines();
		removeMassTreeElements();
		removeTreeEditorListeners();
		
		if(curTree)
			dataManager.changeCurrentPage(curTree.ID);

		if (main.contains(btLine))
		{
			main.removeChild(btLine);
			curLine.mark = false;
		}
			
		masIndex = [];
		masMaxOfIndex = [];
		massLines = [];
	}
	
	
	
	private function  getApplicationStructure(dtManEvt:DataManagerEvent):void
	{
//		dataManager.removeEventListener(DataManagerEvent.GET_APPLICATION_STRUCTURE_COMPLETE, getApplicationStructure);
		
		unMarkButton();
		
		xmlApplicationStructure = dtManEvt.result;
		createTreeArr(xmlApplicationStructure);
		drawLines(xmlApplicationStructure);

		if (needCreatTree == true)
		{
			hideLenes();
			adjustmentTree(xmlApplicationStructure);
			saveToServer();
			
			
			var delayTimer:Timer = new Timer(1500, 1);
			delayTimer.addEventListener(TimerEvent.TIMER, timerHandler);//		removeMassTreeElements();
			delayTimer.start();
			
			return;
		}
		
		curTree = massTreeElements[dataManager.currentPageId];
		startPage = dataManager.currentApplicationInformation.Index;
		
		
		setStartPage();
		
		
		if(curTree != null)
			curTree.current = true;
	}
	
	private var dX:Number;
	private var dY:Number;
	private function startReDrawLineHandler(trEvt:TreeEditorEvent):void
	{
		// object to Top
		main.removeChild(massTreeElements[trEvt.ID]);
		main.addChild(massTreeElements[trEvt.ID]);
		
		dX = main.mouseX - massTreeElements[trEvt.ID].x;
		dY = main.mouseY - massTreeElements[trEvt.ID].y;
		
		Application.application.addEventListener(MouseEvent.MOUSE_MOVE, mouseMoveHandler);
		Application.application.addEventListener(MouseEvent.MOUSE_UP, 	mouseUpHandler);
	}
	
	private function stopReDrawLineHandler(trEvt:TreeEditorEvent):void
	{
		main.removeEventListener(MouseEvent.MOUSE_MOVE, mouseMoveHandler);
		
		var curID:String = curTree.ID;
		redrawLines(curID);
	}
	
	
	private function hideTreeElement(trEvt:Object):void
	{
		massTreeElements[curTree.ID].resize = true;
	}
	

	private function lineClikHandler(msEvt:MouseEvent):void
	{
		removeLine();
	}
		
	
	private function markLines(muEvt:MouseEvent):void
	{
		curLine.mark = false;
		curLine = muEvt.currentTarget;
		curLine.mark = true;
		btLine.x = main.horizontalScrollPosition + mouseX - btLine.width / 2;
		btLine.y = main.verticalScrollPosition + mouseY  - btLine.height - 2;
		btLine.visible = true;
		
		if (!main.contains(btLine))
		{
			main.addChild(btLine);
		}
		muEvt.stopImmediatePropagation();
	}
	
	private function treeElementLinesReDrawHandler(trEvt:TreeEditorEvent):void
	{
		if(trEvt.currentTarget.ID != null)
			redrawLines(trEvt.currentTarget.ID); 
	} 
	
	/** 
	*
	*		Кликнули по обьекту, 
	*		- выделяем его
	*		- если надо проводим к нему линию связи с 
	*		с от другого обьекта
	*/
	
	private function mouseDownHandler(evt:MouseEvent):void
	{
		// проводим линию
		if(blDrawLine)
		{
			pnFrom.x = evt.currentTarget.x; 
			pnFrom.y =evt.currentTarget.y;
			
			drawLine(evt.currentTarget);
		}		

		if (curTree != null)
			curTree.current = false;	
		
		evt.currentTarget.current = true;
		curTree = evt.currentTarget;		
		dataManager.changeCurrentPage(curTree.ID);
	}
	
	
	
	private function mouseUpHandler(msEvt:MouseEvent):void
	{	
		Application.application.removeEventListener(MouseEvent.MOUSE_MOVE, mouseMoveHandler);
		Application.application.removeEventListener(MouseEvent.MOUSE_UP, 	mouseUpHandler);
		
//		saveToServer();
		markButton();
	}
	
	private var treeElemenUnderMouse:Object;
	private function treeElementMouseOutHandler(msEvt:MouseEvent):void
	{
		treeElemenUnderMouse = null;
		msEvt.currentTarget.availabled = true;
		
	}
	
	private function treeElementMouseOverHandler(msEvt:MouseEvent):void
	{
		if(blDrawLine)
		{
			msEvt.currentTarget.availabled = false;
		}
		treeElemenUnderMouse = msEvt.currentTarget;
	}
	
	
	private function mouseMoveHandler(msEvt:MouseEvent):void
	{
		var curID:String = curTree.ID;
		
		if(!massTreeElements[curID])
			return;
			
		if (main.mouseX < dX)
			 	massTreeElements[curID].x = 0;
			else
				massTreeElements[curID].x = main.mouseX - dX;
		
		if ((main.mouseY -dY ) < 10)
			 	massTreeElements[curID].y = 10;
			else
				massTreeElements[curID].y = main.mouseY - dY;
	
		redrawLines(curID);
	}
	/**
	*
	*		удаляем обьект и все его связи
	*
	*/
	private var massDeletedElemens:Array = new Array(); // of String
	private function deleteTreeElement(trEvt:TreeEditorEvent):void
	{
		curTree.current = false;
		curTree = massTreeElements[trEvt.ID];
		curTree.current = true;
		dataManager.changeCurrentPage(curTree.ID);
		Alert.show(resourceManager.getString('Tree','do_you_want_to_delete_element'), resourceManager.getString('Tree','delete_element'), 3, this, alertClickDeleteTreeElement);
	}
	 
    private function alertClickDeleteTreeElement(event:CloseEvent):void 
    {
        if (event.detail==Alert.YES)
        {
        	dataManager.addEventListener(DataManagerEvent.DELETE_OBJECT_COMPLETE, deleteObjectHandler)
        	dataManager.deleteObject(curTree.ID);
        }
    }
    
    private function deleteObjectHandler(dmEvt:DataManagerEvent):void
    {
    	dataManager.removeEventListener(DataManagerEvent.DELETE_OBJECT_COMPLETE, deleteObjectHandler)
    	deleteObject(curTree.ID);
           	
		curTree = massTreeElements[randomTreeElement];
		
		if(curTree)
		{
			curTree.current = true;
			dataManager.changeCurrentPage(curTree.ID);
		}
		
		setStartPage();
		saveToServer();
    }
	
	/**
	*
	*		запускаем прорисовку линию от елемента дерева
	*		до курсора мыши
	*
	*/
	private function startDrawLine(trEvt:TreeEditorEvent):void
	{
		if(!colmen2.openedEyeOfSelectedLevel)
			return;
			
		vctTest = new Vector2();
		main.addChild(vctTest);//--для рисования связывающей линии
		addEventListener(MouseEvent.MOUSE_MOVE, drLine);
		
		blDrawLine = true; //говорим что рисуем линию
		addEventListener(MouseEvent.MOUSE_DOWN, stopDrawLine);
		drLine(new MouseEvent(MouseEvent.MOUSE_OVER));
		vctTest.graphics.clear();
	}
	
	private function saveToServerHandler(trEvt:TreeEditorEvent):void
	{
//		saveToServer();
		markButton();
	}
	
	
	/**
	* ресурсы
	*		перестаем рисовать линию от елемента дерева
	*		до курсора мыши
	*
	*/
	private function stopDrawLine(msEvt:MouseEvent):void
	{
		removeEventListener(MouseEvent.MOUSE_MOVE, drLine);
		removeEventListener(MouseEvent.MOUSE_DOWN, stopDrawLine);
		
		vctTest.clear();
		main.removeChild(vctTest); ///-------------***********
		blDrawLine = false;  //говорим что НЕ рисуем линию
	}
	
	/**
	*
	*		рисуем линию от елемента дерева
	*		до курсора мыши
	*
	*/
	private function drLine (mEvt:MouseEvent):void
	{
//		trace(main.measuredWidth);
		if(mouseX > main.width - 100 &&  (main.horizontalScrollPosition + main.width - main.measuredWidth) < 9)
			main.horizontalScrollPosition = main.horizontalScrollPosition + 10;	
		else if(mouseX < main.x + 100 && main.horizontalScrollPosition > 9)
			main.horizontalScrollPosition = main.horizontalScrollPosition - 10;	
		else if(mouseY > main.height - 100 && (main.verticalScrollPosition + main.height - main.measuredHeight) < 9)
			main.verticalScrollPosition = main.verticalScrollPosition + 10;	
		else if(mouseY < main.y + 100 &&  main.verticalScrollPosition > 9)
			main.verticalScrollPosition = main.verticalScrollPosition - 10;	
			
		vctTest.graphics.clear();
		
		if(treeElemenUnderMouse)
		{
			vctTest.createVector(curTree, treeElemenUnderMouse, colmen2.selectedItem.data);	
		}else
		{
			var pnTo:Object = calculatePointTo(mouseX + main.horizontalScrollPosition, mouseY + main.verticalScrollPosition , curTree);
		
			vctTest.createVector(curTree, pnTo, colmen2.selectedItem.data);	
		}
	}
	
		
		
	private function dataManagerListenner(dmnEvt:DataManagerEvent):void
	{
		dataManager.removeEventListener(DataManagerEvent.SET_APPLICATION_STRUCTURE_COMPLETE, dataManagerListenner)
	}
	
	
	private function hideLines(treEvt:TreeEditorEvent):void
	{
		var level:String = treEvt.ID;
		for (var frsTrElem:String in massLines[level])
			for (var sknTrElem:String in massLines[level][frsTrElem])
			{
				massLines[level][frsTrElem][sknTrElem].visible = false;
				masIndex[level][frsTrElem][sknTrElem].visible  = false;
			}
	}
	
	private function showLines(treEvt:TreeEditorEvent):void
	{
		var level:String = treEvt.ID;
		for (var frsTrElem:String in massLines[level])
			for (var sknTrElem:String in massLines[level][frsTrElem])
			{
				massLines[level][frsTrElem][sknTrElem].visible = true;
				masIndex[level][frsTrElem][sknTrElem].visible  = true && chShowSignature.selected;;
			}
	}

	private function chengeSelectedLevelHandler(trEvt:TreeEditorEvent):void
	{
		var level:String = trEvt.ID;
		if(!massLines[level])
			return;
		
		for(var fromObj:String in massLines[level])
			for(var toObj:String in massLines[level][fromObj])
			{
				main.removeChild(massLines[level][fromObj][toObj]);
				main.addChild(massLines[level][fromObj][toObj]);
				
				main.removeChild(masIndex[level][fromObj][toObj]);		
				main.addChild(masIndex[level][fromObj][toObj]);
			}
			
		for (var ID:String in massTreeElements)
		{
				main.removeChild(massTreeElements[ID]);
				main.addChild(massTreeElements[ID]);
		}
		
	}

	private function mouseClickHandler(msEvt:MouseEvent):void
	{
		for (var ID:String in massTreeElements)
				if(massTreeElements[ID].select) 
					massTreeElements[ID].unSelect();

		if (main.contains(btLine))
		{
			main.removeChild(btLine);
			curLine.mark = false;
		}
	
	}
	
	private var startPage:String;
	private function changeStartPageHandler(treEvt:TreeEditorEvent):void
	{
		if(massTreeElements[startPage])
			massTreeElements[startPage].selected = false;
			
		startPage = treEvt.ID
		
		var data:XML = new XML( 
		'<Information>' + 
			'<Index>' + startPage +	'</Index>' + 
		'</Information>');

		dataManager.addEventListener(DataManagerEvent.SET_APPLICATION_INFO_COMPLETE, applicationInfoChangeHAndler); 
		dataManager.setApplicationInformation( dataManager.currentApplicationId, data);
	}
	
	private function applicationInfoChangeHAndler(dmEvt:DataManagerEvent):void
	{
		dataManager.removeEventListener(DataManagerEvent.SET_APPLICATION_INFO_COMPLETE, applicationInfoChangeHAndler);
		
		setStartPage();
	}
	
	
	private var treeElement:TreeElement = new TreeElement();
	
	private function addTreeElementLauncher():void 
	{
			var rbWnd:AddTreeElementWindow = AddTreeElementWindow(PopUpManager.createPopUp(this, AddTreeElementWindow, true));
			rbWnd.addEventListener(AddTreeElementEvent.TREE_ELEMENT_ADDED, addTreeElementHandler);
	}

	private function addTreeElementHandler(adTrEvt:AddTreeElementEvent):void 
	{
		var ID:String = adTrEvt.treeElementID
		var trEl:TreeElement = new TreeElement();
		
		trEl.ID =  ID;
		trEl.name =  adTrEvt.title;
		trEl.type =  adTrEvt.trElementType;
		trEl.resourceID  =  adTrEvt.resourceID;
		trEl.description =  adTrEvt.description;
		trEl.typeID = adTrEvt.typeResourse;
		trEl.state = chExpandAll.selected.toString();
		
		var maxY:Number = 0;
		for (var tID:String in massTreeElements)
				if(massTreeElements[tID].y > maxY) 
					maxY = massTreeElements[tID].y;
					
		trEl.y = maxY + 100;
		
		massTreeElements[ID] = addEventListenerToTreeElement(trEl);
		main.addChild(massTreeElements[ID]);
		fileManager.loadResource(dataManager.currentApplicationId,  trEl.resourceID, massTreeElements[ID]);
		
		//select new object
		if(curTree != null)
			curTree.current = false;
		curTree = massTreeElements[ID];
		if(curTree != null)
		{
			curTree.current = true;
			dataManager.changeCurrentPage(curTree.ID);
		}
		
		saveToServer();
	}
	
	private function autoSpacing():void
	{
		hideLenes();
		adjustmentTree(xmlApplicationStructure);
		
		var delayTimer:Timer = new Timer(1500, 1);
		delayTimer.addEventListener(TimerEvent.TIMER, timerHandler);//		removeMassTreeElements();
		delayTimer.start();
		markButton();
//		createTreeArr(xmlApplicationStructure);
		
	}
	private function timerHandler(tmEvt:TimerEvent):void
	{
		showLenes();
		
		curTree = massTreeElements[dataManager.currentPageId];
		
		if(curTree != null)	curTree.current = true;
		
		setStartPage();
		
//		saveToServer();
	}
	
	
	private var expand:Boolean;
	private function expandAll():void
	{
		expand = chExpandAll.selected;
		
		for (var tID:String in massTreeElements)
		{
			massTreeElements[tID].state = expand.toString();
		}
		
	} 
	
	private function showSignature():void
	{
		
		for(var level:String in massLines)
		{
			if(colmen2.showLevel(level) == true)
			{
				for(var ind1:String in massLines[level])
				{
					for(var ind2:String in massLines[level][ind1])
					{
						masIndex[level][ind1][ind2].visible = chShowSignature.selected;
					}
				}
			}
		}
	}
	]]>
</mx:Script>
<!--
	<mx:ComboBox x="28" y="46" >
	 <mx:ArrayCollection>
         <mx:String>1</mx:String>
         <mx:String>2</mx:String>
         <mx:String>3</mx:String>
      </mx:ArrayCollection>
	</mx:ComboBox>
-->
	</mx:Canvas>
	<mx:HBox bottom="0" backgroundColor="0xFFFFFF" width="100%" height="30" 
			paddingLeft="5" paddingBottom="5" paddingRight="5" paddingTop="5">
		<mx:VRule height="100%"/>
		<mx:Button  label="{resourceManager.getString('Tree','new_page')}"  
		 	 click="addTreeElementLauncher()"/>
	 	<mx:Button  label="{resourceManager.getString('Tree','auto_Spacing')}"    click="autoSpacing()"/>
	 	<mx:VRule height="100%" />
		<mx:CheckBox id="chExpandAll" label= "{resourceManager.getString('Tree','expand_all')}"  click="expandAll()"/>
		<mx:CheckBox id="chShowSignature" label= "{resourceManager.getString('Tree','show_signature')}"
		  click="showSignature()"/>
		 <mx:VRule height="100%" />
		<mx:Button id="btSave" label="Save" click="{saveToServer()}"/>
		<mx:Button label="Revert" click="{revert()}"/>
		<mx:VRule height="100%" />
		
	</mx:HBox>
		
</mx:VBox>


<mx:Canvas right="0">
	
	<colorMenu02:ColorMenu2 id="colmen2" text="{resourceManager.getString('Tree','levels')}" />
</mx:Canvas>
	

		  	
	

</mx:HBox>

</mx:Canvas>