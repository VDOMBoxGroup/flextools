<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="creationCompleteHandler()" xmlns:eventEditor="vdom.components.eventEditor.*">
	 <mx:Script>
	 	<![CDATA[
	 		import vdom.events.TreeEditorEvent;
	 		import mx.controls.Tree;
	 		import vdom.components.treeEditor.Vector2;
	 		import vdom.managers.DataManager;
	 		import mx.collections.ArrayCollection;
	 		import mx.controls.DataGrid;
	 		import mx.controls.Text;
	 		import mx.core.DragSource;
	 		import mx.events.DragEvent;
	 		import mx.managers.DragManager;
	 		import vdom.components.treeEditor.TreeElement;
	 		
	 		[Bindable]
	 		private var dataManager:DataManager;
	 		
	 		private var linesArray:Array = new Array();
	 		
	 		private function creationCompleteHandler():void
	 		{
	 			dataManager = DataManager.getInstance();
	 		}
	 	
	 		
	 		 private function dragEnterHandler(event:DragEvent):void 
	 		 {
	 		 
	 		   if( event.dragInitiator is TreeActions ) {
	 		   	trace('event.dragInitiator is TreeActions ')
	                    
	                    /*
	                    var ds:DragSource = event.dragSource;
	                    if( !ds.hasFormat("treeItems") ) return;     // no useful data
	
	                    var items:Array = ds.dataForFormat("treeItems") as Array;
	                    for(var i:Number=0; i < items.length; i++) {
	
	                        var item:XML = XML(items[i]);
	                        if( item.@label != "Personal" ) return; // not what we want
	
	                    }
	                    */
	                } 
				
	                var dropTarget:Canvas=Canvas(event.currentTarget);
	                DragManager.acceptDragDrop(dropTarget);
	        }
            
            private var eventsArray	:Array = new Array();
            private var actionsArray:Array = new Array();
                
	        private function dragDropHandler(event:DragEvent):void 
	        {
	        	var newElement:*;
	        	  if( event.dragInitiator is TreeActions ) 
	        	  {
	        		 newElement =  new EventEditorAction(Math.random());
	        		 newElement.addEventListener(MouseEvent.CLICK, stopDrawLine);
	        		 eventsArray[newElement.ID] = newElement;
	        	  } 
	        	  else if (event.dragInitiator is TreeEvents ) 
	        	  {
	        	  	newElement = new EventEditorEvent(Math.random());
	        	  	newElement.addEventListener(TreeEditorEvent.START_DRAW_LINE, startDrawLine);
	        	  	actionsArray[newElement.ID] = newElement;
	        	  }
	        	  
	        	trace('Created new element: '+newElement.ID);
	        	newElement.x = event.localX;
	        	newElement.y = event.localY;
	        	
	 			can.addChild(newElement); 
	        }   
	        
	        private function onTreeDragComplete(event:DragEvent):void 
	        {
                event.preventDefault();
            }    
          
          
            /******
            * 
            *	Рисуем линию... 
            * 
            */
            private var blDrawLine:Boolean = false;
            private var line:Vector2 = new Vector2();
        	private var curEvent:Object;
            private function startDrawLine(trEvt:TreeEditorEvent):void
			{
				can.addChild(line);//--для рисования связывающей линии
				can.addEventListener(MouseEvent.MOUSE_MOVE, drLine);
				
				blDrawLine = true; //говорим что рисуем линию
				addEventListener(MouseEvent.MOUSE_DOWN, stopDrawLine);
				
				curEvent = actionsArray[trEvt.ID]
	//			drLine(new MouseEvent(MouseEvent.MOUSE_OVER));
	//			line.graphics.clear();
			}
			// 7-701-249-68-36 cancho 
			// 7-702-153-44-95 vascho
			// 

			
			private function drLine (mEvt:MouseEvent):void
			{
			// нормализуем mouseX mouseY
				 var pt:Point = new Point(mEvt.localX, mEvt.localY);
            		pt = mEvt.target.localToGlobal(pt);
            		pt = can.globalToLocal(pt);
				
				var pnTo:Object = calculatePointTo(pt, curEvent);
				
				line.graphics.clear();
				line.createVector(curEvent, pnTo);	
			}
			
			private function calculatePointTo(pn:Point, curTree:Object):Object
			{
				var tX:int = pn.x - vBox.x - curEvent.x;
				var tY:int = pn.y  - curEvent.y;
				
				var pnTo:Object = new Object();
				// чтоб мышка не кликала по своей линии
				
				if((tX>0))	pnTo.x = pn.x - 10;
					else pnTo.x = pn.x + 10;
				
				if( (tY>0))	pnTo.y = pn.y - 10;
					else pnTo.y = pn.y + 10;
					
				return pnTo;
			}
			
			private function stopDrawLine(msEvt:MouseEvent):void
			{
				can.removeEventListener(MouseEvent.MOUSE_MOVE, drLine);
				removeEventListener(MouseEvent.MOUSE_DOWN, stopDrawLine);
				
				line.clear();
				can.removeChild(line); ///-------------***********
				blDrawLine = false;  //говорим что НЕ рисуем линию
			}
			
			private function stopDrawLine(msEvt:MouseEvent):void
			{
				
				if (!blDrawLine)
					return;
					
				can.removeEventListener(MouseEvent.MOUSE_MOVE, drLine);
				removeEventListener(MouseEvent.MOUSE_DOWN, stopDrawLine);	
				line.clear();
				can.removeChild(line);
				blDrawLine = false; 
				
				linesArray
				
					
			}
			
			
			private function treeContainerChangeHandler(evt:Event):void
			{
				 var selectedNode:XML = Tree(evt.target).selectedItem as XML;
              	 var ID:String = selectedNode.@ID;
              	 trace(ID);
			}
	 	]]>
	 </mx:Script>
	 
	 
	 <mx:XMLList id="treeData">
	    <node label="Mail Box">
	        <node label="Inbox">
	            <node label="Marketing"/>
	            <node label="Product Management"/>
	            <node label="Personal"/>
	        </node>
	        <node label="Outbox">
	            <node label="Professional"/>
	            <node label="Personal"/>
	        </node>
	        <node label="Spam"/>
	        <node label="Sent"/>
		</node>	
    </mx:XMLList>
	
	<mx:HDividedBox width="100%" height="100%">
		 <mx:Canvas label="Canvas 1" width="200" height="100%" >
                <mx:TabNavigator id="tn"  width="100%" height="100%">
		            <!-- Define each panel using a VBox container. -->
					
					<mx:Canvas label="Container"  width="100%" height="100%"  >
			             <eventEditor:TreeContainer id="trContainer" width="100%" height="100%" 
                			 dataProvider="{dataManager.listPages}" change="treeContainerChangeHandler(event)" />
			        </mx:Canvas>
			        
			        <mx:Canvas label="Events"  width="100%" height="100%" >
			             <eventEditor:TreeEvents id="trEvents" width="100%" height="100%" 
                			dataProvider="{treeData}" />
			        </mx:Canvas>
			        
			        <mx:Canvas label="Actions"  width="100%" height="100%" >
			             <eventEditor:TreeActions id="trActions" width="100%" height="100%" 
                			 dataProvider="{treeData}" />
			        </mx:Canvas>
			        

		        </mx:TabNavigator>
            </mx:Canvas>

            <mx:VBox id="vBox" width="100%" height="100%" >
                <mx:Label text="Current container: selected container" fontWeight="bold"  color="0xFFFFFF"/>
                <mx:Canvas id="can" width="100%" height="100%" 
                		backgroundColor="#cccccc"
                	 	dragEnter="dragEnterHandler(event);" 
        				dragDrop="dragDropHandler(event);"/>
            </mx:VBox>
	</mx:HDividedBox>
		

</mx:Canvas>
