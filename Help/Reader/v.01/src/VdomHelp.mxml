<?xml version="1.0" encoding="utf-8"?>
<mx:WindowedApplication
	
	showStatusBar="false"
	showGripper="false"
	
	xmlns:vdomTitleBar="vdom.core.vdomTitleBar.*"
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	layout="absolute" creationComplete="{creatComleatHandler()}" viewSourceURL="srcview/index.html" 
	backgroundColor="0x373739"   width="700" height="600" titleBarColors="[ 0x666666, 0x222222 ]" title="VDOM Help Aplication" 
	titleTextStyleName="tbStyle" titleIcon="@Embed('../assets/bookmarks.png')" xmlns:local="*">
	<mx:Style>
		.tbStyle {
			color : #FFFFFF;
		}
	</mx:Style>
	<mx:Script>
	<![CDATA[
		import mx.controls.List;
		import mx.events.ListEvent;
		import mx.collections.XMLListCollection;
		import mx.printing.FlexPrintJobScaleType;
		import mx.printing.FlexPrintJob;
		import mx.utils.StringUtil;
		import mx.events.TreeEvent;
		import mx.utils.Base64Decoder;
		
		private var install:XML = new XML();
		private var XML_URL:String = "StartXML.xml";
		private var myXMLURL:URLRequest;
		private var myLoader:URLLoader;
//		private var cacheFolder:File;
		private var fileStream:FileStream = new FileStream();
		private var sqlProxy:SQLProxy = new SQLProxy();
		private var pageList : List = new List();
		
		
		
		/***
		 * 
		 * 	Иконки для дерева (лист и книжка)
		 * 	Квадратик на верх
		 * 	? стрелочки лево право
		 * 
		 * */
		
		private function creatComleatHandler():void
		{
			pageList.percentWidth = 100; 
			pageList.percentHeight = 100; 
			pageList.labelField = "title";
			pageList.addEventListener(ListEvent.CHANGE, listChangeHandler); 
			pageList.setStyle("color", "#000000");
			searchResult.addChild(pageList);
			
			var result:Object = sqlProxy.getToc();
			var tocOfProducts : XMLListCollection = new XMLListCollection();
			
			if(result)
			{
				for (var i:String in result)
				{
					var tempXML : XML = result[i]["toc"];
					for each(var child:XML in tempXML.children())
						tocOfProducts.addItem(child);
				}
			}
			
			tree.dataProvider  = tocOfProducts;
			
			var pages : Object = sqlProxy.getPages();
			if(pages)
			{
				for (i in pages)
				{
					var name :String = pages[i]["name"];
					arrayOfPages[name] = true;
				}
			}
			
		}
		
		// start loading 1-st XML 
		private function frstLoadXML():void
		{
			myXMLURL = new URLRequest(XML_URL)
			myLoader = new URLLoader(myXMLURL);
			myLoader.addEventListener(Event.COMPLETE, startXMLLoaded);
			myLoader.addEventListener(IOErrorEvent.IO_ERROR, startXMLLoaded);
			sqlProxy.creatDB();
		}
		
		// 
		private function startXMLLoaded(event:Event):void
		{
			myLoader.removeEventListener(Event.COMPLETE, startXMLLoaded);
			if(event.type == IOErrorEvent.IO_ERROR)
			{
				trace("!!!!!!!!!!!!!! Start XML not Finded !!!!!!!!!")	
			} 
			else if(event.type == Event.COMPLETE)
			{
//			    trace("Start loaded.");
				 
				install = XML(myLoader.data);
				for each(var product:XML in install.children())
				{
//					trace(product.@url);
					var xmlURL:URLRequest = new URLRequest(product.@url)
					var loader:URLLoader = new URLLoader(xmlURL);
					loader.addEventListener(Event.COMPLETE, xmlLoaded);
					loader.addEventListener(IOErrorEvent.IO_ERROR, xmlLoaded);
				} 
			}
		}
		
		private function xmlLoaded(event:Event):void
		{
			if(event.type == IOErrorEvent.IO_ERROR)
			{
				trace("!!!! XML not Finded  !!!!")	
			} 
			else if(event.type == Event.COMPLETE)
			{
			    parsingData(XML(event.target.data))
			}
		}
		
		private function parsingData(product:XML):void
		{
			if(product == null || product.name() != "product")
			{
				trace("!!!!!!!!!!!! not Correct data from server !!!!!!!!!!!!!");
				return;
			}
			var name:String = product.name.toString();
			var version:String = product.version.toString();
			var title:String = product.title.toString();
			var description:String = product.description.toString();
			var language:String = product.language.toString();
			var toc:XML = tocToBD(product.toc[0],language, name);
			
			
			// save product to data base
			
			var curPageVersion:String = sqlProxy.getVersionOfProduct(name, language);
				
				if(curPageVersion == '')
				{
//					sqlProxy.setPage(productName, language, pageLocation, version, title, description, content);
					sqlProxy.setProduct(name,version,title,description, language,toc);
				}
				else if (Number(curPageVersion)< Number(version))
				{
					//delete old data Find nessasri page 
					deleteProduct(name, language);
//					sqlProxy.setPage(productName, language, pageLocation, version, title, description, content);
					
					sqlProxy.setProduct(name, version, title, description, language,toc);
				}
			
			// save loaded data to local diskDrive 
			saveLoadedData(product);
			
			// выбрать странички сохранить их на диск
			savePages(product);
			
//			creatTree(toc);
			
		}
		
		private function tocToBD(value:XML, lan:String, product:String):XML
		{
			changeStruxcture(value);
		
			return value ;
			
			function changeStruxcture(xml:XML):void
			{
				for each(var page:XML in xml.children())
				{
					page.@name = lan + "/" + product + "/"  + page.@name + ".html";
					changeStruxcture(page);
				}
			}
		}
		
		private function saveLoadedData(product:XML):void
		{
			var byteArray:ByteArray = new ByteArray();
				byteArray.writeMultiByte(product.toXMLString()+"\n", "UTF-8");
				
				var fileName:String =  product.name.toString()+ ".xml";
			cacheFile( fileName, byteArray);
		}
		
	/*	private function saveResources(product:XML):void
		{
			for each(var page:XML in product.pages.children())
			{
				
			}
		}
		*/
		private var arrayOfPages:Array = new Array();
		
		private function savePages(product:XML):void
		{
			var productName:String =  product.name.toString(); 
			var language:String =  product.language.toString(); 
			var location:String = language +"/"+productName+"/"; 
			
			//********* Creat PAGES ***********//
			for each(var page:XML in product.pages.children())
			{
				var pageName:String = page.name.toString() + ".html"; 
				var version:String = page.version.toString(); 
				var title:String = page.title.toString();
				var description:String = page.description.toString();
				var content:String = page.content.toString();
				var pageLocation:String = location + pageName;
				
				arrayOfPages[pageLocation] = true;
//				sqlProxy.

				// проверяем есть ли эта страница уже в базе. берем версию страницы ////getVersionOfPage(): string//////
				// страница не найдена - записываем
				// страница найдена 1) старая - удаляем, записываем 2) такая же - пропускаем				
				// deletePage(namePage); getResourcesOfPage(namePage):Array; deleteResorces(namePage);
				
				var curPageVersion:String = sqlProxy.getVersionOfPage(pageLocation);
				
				if(curPageVersion == '')
				{
					sqlProxy.setPage(productName, language, pageLocation, version, title, description, content);
				}
				else if (Number(curPageVersion)< Number(version))
				{
					//delete old data
					deletePage(pageLocation);
					sqlProxy.setPage(productName, language, pageLocation, version, title, description, content);
				} else
				{
					continue;
				}
				
				
				
				var byteArray:ByteArray = new ByteArray();
					byteArray.writeMultiByte(page.content.toString()+"\n", "UTF-8");
//				var fileName:String = pageName;
				
				cacheFile(pageLocation, byteArray);
				
				arrayOfPages[pageLocation] = true;
				
				
				//*************  Creat Resources  ***************//
				for each(var resource:XML in page.resources.children())
				{
					var base64:Base64Decoder = new Base64Decoder();
						base64.decode(resource.toString());
					
					var byteArray0:ByteArray = base64.toByteArray();
					
					var resourceName:String = "resources/"+ resource.@id + "." + resource.@type;
					
					cacheFile(location + resourceName , byteArray0);
					
					sqlProxy.setResource(pageLocation, location + resourceName);
				}
			}
			
			
//			pageList.dataProvider = sqlProxy.search("conten of page","VdomHelp_en_US");
			
		}  
		
		private function deleteProduct(name:String, language:String):void
		{
//			get All pages of product 
			var pages:Object = sqlProxy.getProductsPages(name, language);
			for (var page:String in pages)
			 deletePage(pages[page].name);
			 
			sqlProxy.deleteProduct(name, language);
		}
		
		private function deletePage(namePage:String):void
		{
			var resources:Object = sqlProxy.getResourcesOfPage(namePage);
			
			for(var index:String in resources)
			{
				deleteFile(resources[index]['name']);
			}
			
			sqlProxy.deleteResources(namePage);
			sqlProxy.deletePage(namePage);
			
		}
		
		private function deleteFile(location:String):void
		{
			trace("Delete: " + location);
			var newFileName:String = location;
			var newFile:File = File.applicationStorageDirectory.resolvePath(newFileName);
			newFile.deleteFile();
//			trace(newFile.toString())
		}
		
		public function cacheFile(contentName:String, content:ByteArray):void 
		{
			var newFileName:String = contentName;
			var newFile:File = File.applicationStorageDirectory.resolvePath(newFileName);
//			trace(newFile.toString())
			try {
				
				fileStream.open(newFile, FileMode.WRITE);
				fileStream.writeBytes(content);
				fileStream.close();
				
			} catch(error:IOError) {
//				var er:* =  error;
				trace("!!!!!!!!!!!!!!!! Error Write !!!!!!!!!!!!!!! \n" + error.message +"\n"+newFileName);
				return;
			}
		}
			
		private function creatTree(product:XML):void
		{
			
//			var toc:XML =  new XML();
//				toc = product.toc[0];
			tree.dataProvider = product;
			tree.selectedIndex = 0;
			tree.validateNow();
			
			if(tree.selectedItem)
			{
				var pageName:String = tree.selectedItem.@name;
				showSelectedPage(pageName);
			}
		}
		
			
		private function treeChangeHandler(object:Object):void
		{
			showSelectedPage(tree.selectedItem.@name);
			
		}
		
		private function listChangeHandler(object:ListEvent):void
		{
			showSelectedPage(pageList.selectedItem.name);
			
		}
		
		
		private function showSelectedPage(pageName:String):void
		{
			var fileName:String = pageName	;
			var newFile:File = File.applicationStorageDirectory.resolvePath(fileName);
			var fullPath : String = newFile.nativePath;
			html.location = fullPath; 
			fileStream.close();
			
		}
		
		private function pageChangedHandler(event:Event):void
		{
			
			var fullPath:String = html.location;
//			var index:Number = Math.max(fullPath.lastIndexOf( "/" ),fullPath.lastIndexOf( "\\") );
			var index:Number =  fullPath.lastIndexOf( "Local Store");
			var fileName : String = fullPath.substr( index + 12 ); 
//			fileName = fileName.substring( 0, fileName.lastIndexOf( "." )  );
//			trace(fullPath);
			var phraseRE:RegExp = /\\/gim;

			fileName = fileName.replace(phraseRE,"/"); 
			
			
			if(!tree.selectedItem)
				return;
			var selectedItem:String = tree.selectedItem.@name;
			
			if(selectedItem == fileName)
				return;
			
			if(arrayOfPages[fileName])
			{
				selectNecessaryItem(fileName);
			}else
			{
				navigateToURL(new URLRequest(fullPath));
				showSelectedPage(selectedItem);
			}
		}
		
		private function selectNecessaryItem(fileName:String):void
		{
			var currentElement:XML = tree.dataProvider.source..page.(@name == fileName)[0];
			
			openTree(currentElement);
			
			tree.selectedItem = currentElement;
			
			var index:int =  tree.getItemIndex(tree.selectedItem);
			tree.scrollToIndex(index);
		}
		
		private function openTree(item:Object):void
		{
			var parentItem:Object = XML(item).parent();
			if (parentItem)
			{
				openTree(parentItem);
				tree.expandItem(parentItem, true, false);
				tree.validateNow();
			}
		}
		
		private function search():void
		{
			accordion.selectedIndex = 1;
			accordion.validateNow();
				
			pageList.dataProvider  = null;
			pageList.dataProvider = sqlProxy.search(searchWord.text);
			pageList.selectedItem = null;
		}
		
		private function print():void
		{
			
				var zzz : HTML = new  HTML();
				zzz.htmlText = html.htmlText;
				
			 // Create an instance of the FlexPrintJob class.
                var printJob:FlexPrintJob = new FlexPrintJob();

                // Start the print job.
                if (printJob.start() != true) return;

                // Add the object to print. Do not scale it.
                printJob.addObject(html, FlexPrintJobScaleType.MATCH_WIDTH);
                

                // Send the job to the printer.
                printJob.send();

		}
	]]>
</mx:Script>
	
<mx:VBox width="100%" height="100%"   x="0">
	
	<mx:HBox paddingTop="5" paddingLeft="5">
		<local:LeftArrow click="{html.historyBack()}"  htmlPage="{html}"/>
		<local:RightArrow click="{html.historyForward()}"  htmlPage="{html}"/>
		<mx:Image source="@Embed('../assets/gear_i.png')" />
		
		<mx:TextInput id="searchWord" x="185" y="14" width="141"  enter="{search();}" />
		<mx:Button  label="Search" click="{search();}" icon="@Embed('../assets/search.png')" color="#FFFFFF" 
			fillColors="#333333"  textSelectedColor="#FFFFFF" cornerRadius="1" borderColor="#262626" themeColor="#656565" textRollOverColor="#FFFFFF"/>
		<mx:Button click="{frstLoadXML()}"	label="Creat DB"/>
	</mx:HBox>
	<mx:HRule width="100%" strokeColor="0x000000" shadowColor="0x555555"/>
	<mx:HDividedBox y="60" width="100%" height="100%" horizontalGap="1">
		<mx:Accordion id="accordion" width="155" height="100%" addedEffect="false" backgroundColor="#000000" color="#FFFFFF" >
			<mx:Canvas label="Content" width="100%" height="100%" icon="@Embed('../assets/contents.png')">
				<mx:Tree id="tree" width="100%" height="100%" color="#000000"
				labelField="@title" showRoot="false" change="{treeChangeHandler(event)}" />
			</mx:Canvas>
			<mx:Canvas id="searchResult" label="Search Result" width="100%" height="100%" icon="@Embed('../assets/search.png')">
				
			</mx:Canvas>
			<mx:Canvas label="Bookmarks" width="100%" height="100%" icon="@Embed('../assets/bookmarks.png')">
				
			</mx:Canvas>
		</mx:Accordion>
		<mx:VBox width="100%" height="100%" verticalGap="0" verticalAlign="0">
			
			<mx:Canvas color="#FCFBFB"  width="100%" backgroundColor="#E4E4E4" >
				<mx:HBox right="0" paddingRight="10" paddingTop="5" paddingLeft="5" paddingBottom="5">
					<mx:Image source="@Embed('../assets/printer.png')" click="{print()}"/>
					<mx:Image source="@Embed('../assets/bookmark__plus.png')"/>
				</mx:HBox>
			</mx:Canvas>
			<mx:HTML id="html"  width="100%" height="100%" 
				locationChange="{pageChangedHandler(event)}"/>
		</mx:VBox>
	</mx:HDividedBox>
	
	<mx:HBox horizontalAlign="right" width="100%">
		<mx:VBox verticalGap="1" verticalAlign="0">
			<mx:Label text="VDOM Help Application" color="0xFFFFFF" textAlign="right" width="100%"/>
			<mx:Label text="Copyright© 2009 - V.D.O.M. Box Internationl - All rights reserved "  color="0xFFFFFF"/>
		</mx:VBox>
		<mx:Image source="@Embed('../assets/label.png')"/>
	</mx:HBox>
</mx:VBox>		
</mx:WindowedApplication>
